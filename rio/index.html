<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="A steamy river of uring. Fast IO using io_uring."><meta name="keywords" content="rust, rustlang, rust-lang, rio"><title>rio - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><script defer src="../main.js"></script>
    <noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../rio/index.html"><div class="logo-container"><img src="https://raw.githubusercontent.com/spacejam/sled/master/art/tree_face_anti-transphobia.png" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../rio/index.html"><div class="logo-container">
                    <img src="https://raw.githubusercontent.com/spacejam/sled/master/art/tree_face_anti-transphobia.png" alt="logo"></div>
        </a><h2 class="location"><a href="#">Crate rio</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 0.9.4</li><li><a id="all-types" href="all.html">All Items</a></li></div></ul><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li><li><a href="#functions">Functions</a></li></ul></div></section><div id="sidebar-vars" data-name="rio" data-ty="mod" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../rio/index.html">
                        <img src="https://raw.githubusercontent.com/spacejam/sled/master/art/tree_face_anti-transphobia.png" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">rio</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/rio/lib.rs.html#1-310">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>A steamy river of uring. Fast IO using io_uring.</p>
<p>io_uring is going to change everything. It will speed up your
disk usage by like 300%. Go ahead, run the <code>O_DIRECT</code> example
and compare that to using a threadpool or anything
you want. It’s not gonna come close!</p>
<p>Starting in linux 5.5, it also has support for tcp accept.
This is gonna shred everything out there!!!</p>
<p>But there’s a few snags. Mainly, it’s a little misuse-prone.
But Rust is pretty nice for specifying proofs about
memory usage in the type system. And we don’t even have
to get too squirley. Check out the <code>write_at</code> implementation,
for example. It just says that the Completion, the underlying
uring, the file being used, the buffer being used, etc…
will all be in scope at the same time while the Completion
is in-use.</p>
<p>Most of the other io_uring libraries make
it really easy to blow your legs off with
use-after-frees. <code>rio</code> uses standard Rust
lifetime specification  to make most use-after-frees
fail to compile. Also, if a <code>Completion</code>
that was pinned to the lifetime of a uring
and backing buffer is dropped, it
waits for its backing operation to complete
before returning from Drop, to further
prevent use-after-frees. use-after-frees
are difficult to express when using <code>rio</code>.</p>
<h2 id="examples"><a href="#examples">Examples</a></h2>
<p>This won’t compile:</p>

<div class='information'><div class='tooltip compile_fail'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered compile_fail"><code><span class="kw">let</span> <span class="ident">rio</span> <span class="op">=</span> <span class="ident">rio::new</span>().<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">file</span> <span class="op">=</span> <span class="ident">std::fs::File::open</span>(<span class="string">&quot;use_after_free&quot;</span>).<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">out_buf</span> <span class="op">=</span> <span class="macro">vec!</span>[<span class="number">42</span>; <span class="number">666</span>];

<span class="kw">let</span> <span class="ident">completion</span> <span class="op">=</span> <span class="ident">rio</span>.<span class="ident">write_at</span>(<span class="kw-2">&amp;</span><span class="ident">file</span>, <span class="kw-2">&amp;</span><span class="ident">out_buf</span>, <span class="number">0</span>).<span class="ident">unwrap</span>();

<span class="comment">// At this very moment, the kernel has a pointer to that there slice.</span>
<span class="comment">// It also has the raw file descriptor of the file.</span>
<span class="comment">// It&#39;s fixin&#39; to write the data from that memory into the file.</span>
<span class="comment">// But if we freed it, it would be a bug,</span>
<span class="comment">// and the kernel would write potentially scandalous data</span>
<span class="comment">// into the file instead.</span>

<span class="comment">// any of the next 3 lines would cause compilation to fail...</span>
<span class="ident">drop</span>(<span class="ident">out_io_slice</span>);
<span class="ident">drop</span>(<span class="ident">file</span>);
<span class="ident">drop</span>(<span class="ident">rio</span>);

<span class="comment">// this is both a Future and a normal blocking promise thing.</span>
<span class="comment">// If you&#39;re using async, just call `.await` on it instead</span>
<span class="comment">// of `.wait()`</span>
<span class="ident">completion</span>.<span class="ident">wait</span>();

<span class="comment">// now it&#39;s safe to drop those things in any order.</span></code></pre></div>
<p>Really shines with O_DIRECT:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">std</span>::{
    <span class="ident">fs::OpenOptions</span>,
    <span class="ident">io</span>::{<span class="ident">IoSlice</span>, <span class="prelude-ty">Result</span>},
    <span class="ident">os::unix::fs::OpenOptionsExt</span>,
};

<span class="kw">const</span> <span class="ident">CHUNK_SIZE</span>: <span class="ident">u64</span> <span class="op">=</span> <span class="number">4096</span> <span class="op">*</span> <span class="number">256</span>;

<span class="comment">// `O_DIRECT` requires all reads and writes</span>
<span class="comment">// to be aligned to the block device&#39;s block</span>
<span class="comment">// size. 4096 might not be the best, or even</span>
<span class="comment">// a valid one, for yours!</span>
<span class="attribute">#[<span class="ident">repr</span>(<span class="ident">align</span>(<span class="number">4096</span>))]</span>
<span class="kw">struct</span> <span class="ident">Aligned</span>([<span class="ident">u8</span>; <span class="ident">CHUNK_SIZE</span> <span class="kw">as</span> <span class="ident">usize</span>]);

<span class="kw">fn</span> <span class="ident">main</span>() -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="comment">// start the ring</span>
    <span class="kw">let</span> <span class="ident">ring</span> <span class="op">=</span> <span class="ident">rio::new</span>().<span class="ident">expect</span>(<span class="string">&quot;create uring&quot;</span>);

    <span class="comment">// open output file, with `O_DIRECT` set</span>
    <span class="kw">let</span> <span class="ident">file</span> <span class="op">=</span> <span class="ident">OpenOptions::new</span>()
        .<span class="ident">read</span>(<span class="bool-val">true</span>)
        .<span class="ident">write</span>(<span class="bool-val">true</span>)
        .<span class="ident">create</span>(<span class="bool-val">true</span>)
        .<span class="ident">truncate</span>(<span class="bool-val">true</span>)
        .<span class="ident">custom_flags</span>(<span class="ident">libc::O_DIRECT</span>)
        .<span class="ident">open</span>(<span class="string">&quot;file&quot;</span>)
        .<span class="ident">expect</span>(<span class="string">&quot;open file&quot;</span>);

    <span class="comment">// create output buffer</span>
    <span class="kw">let</span> <span class="ident">out_buf</span> <span class="op">=</span> <span class="ident">Aligned</span>([<span class="number">42</span>; <span class="ident">CHUNK_SIZE</span> <span class="kw">as</span> <span class="ident">usize</span>]);
    <span class="kw">let</span> <span class="ident">out_slice</span> <span class="op">=</span> <span class="ident">out_buf</span>.<span class="number">0</span>.<span class="ident">as_ref</span>();

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">completions</span> <span class="op">=</span> <span class="macro">vec!</span>[];

    <span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="number">0</span>..(<span class="number">4</span> <span class="op">*</span> <span class="number">1024</span>) {
        <span class="kw">let</span> <span class="ident">at</span> <span class="op">=</span> <span class="ident">i</span> <span class="op">*</span> <span class="ident">CHUNK_SIZE</span>;

        <span class="kw">let</span> <span class="ident">completion</span> <span class="op">=</span> <span class="ident">ring</span>.<span class="ident">write_at</span>(
            <span class="kw-2">&amp;</span><span class="ident">file</span>,
            <span class="kw-2">&amp;</span><span class="ident">out_slice</span>,
            <span class="ident">at</span>,
        );
        <span class="ident">completions</span>.<span class="ident">push</span>(<span class="ident">completion</span>);
    }

    <span class="kw">for</span> <span class="ident">completion</span> <span class="kw">in</span> <span class="ident">completions</span>.<span class="ident">into_iter</span>() {
        <span class="ident">completion</span>.<span class="ident">wait</span>()<span class="question-mark">?</span>;
    }

    <span class="prelude-val">Ok</span>(())
}</code></pre></div>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Completion.html" title="rio::Completion struct">Completion</a></div><div class="item-right docblock-short"><p>A Future value which may or may not be filled</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Config.html" title="rio::Config struct">Config</a></div><div class="item-right docblock-short"><p>Configuration for the underlying <code>io_uring</code> system.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Rio.html" title="rio::Rio struct">Rio</a></div><div class="item-right docblock-short"><p>Nice bindings for the shiny new linux IO system</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Uring.html" title="rio::Uring struct">Uring</a></div><div class="item-right docblock-short"><p>The top-level <code>io_uring</code> structure.</p>
</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.Ordering.html" title="rio::Ordering enum">Ordering</a></div><div class="item-right docblock-short"><p>Specify whether <code>io_uring</code> should
run operations in a specific order.
By default, it will run independent
operations in any order it can to
speed things up. This can be constrained
by either submitting chains of <code>Link</code>
events, which are executed one after the other,
or by specifying the <code>Drain</code> ordering
which causes all previously submitted operations
to complete first.</p>
</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.AsIoVec.html" title="rio::AsIoVec trait">AsIoVec</a></div><div class="item-right docblock-short"><p>Encompasses various types of IO structures that
can be operated on as if they were a libc::iovec</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.AsIoVecMut.html" title="rio::AsIoVecMut trait">AsIoVecMut</a></div><div class="item-right docblock-short"><p>We use this internally as a way of communicating
that for certain operations, we cannot accept a
reference into read-only memory, like for reads.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.FromCqe.html" title="rio::FromCqe trait">FromCqe</a></div><div class="item-right docblock-short"><p>A trait for describing transformations from the
<code>io_uring_cqe</code> type into an expected meaningful
high-level result.</p>
</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.new.html" title="rio::new fn">new</a></div><div class="item-right docblock-short"><p>Create a new IO system.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="rio" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.1 (e092d0b6b 2022-07-16)" ></div>
</body></html>